---
output: 
  pdf_document:
    keep_tex: true
header-includes:
    - \usepackage{setspace}\onehalfspacing
---

```{r setup3, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(viridis)
library(zoo)
library(stringr)
library(ggrepel)
library(foreign)
library(AER)
library(lmtest)
library(sandwich)
library(texreg)
options(digits = 8)
options(scipen = 999)
rm(list=ls())
```

```{r, echo = F, include=F}
data = read.csv("data3.csv")
```


# Eksamenssæt 3: Instrumentvariable

## Opgave 1 - Estimer modellen vha. OLS og kommenter på resultaterne    
```{r}
model = lm(learnings ~ educ + exp + male + ethblack + ethhisp, data)
summary(model)
```
hispanics er insignifikant med p-værdi på 33,2\%
Resten er på 1\% eller lavere
Relativ lav $R^2$
F-test med meget lav p-værdi - Variable er "jointly significant"

## Opgave 2 - Hvorfor kunne vi være bekymrede for at uddannelse er endogen? 
Uddannelse vil være endogen hvis den er korreleret med en udeladt variabel som derfor skaber en bias. Denne udeladte variabel kunne eksempelvis være "ability", som påvirker uddannelsesniveauet positivt og dermed skaber en bias, eller forældrenes uddannelsesniveau. Ligeledes kan antallet af søskende have en negativ effekt på uddannelsesniveauet. 

## Opgave 3 - Er siblings, meduc og feduc brugbare som instrumenter?
Hvis de nævnte variable er korreleret med uddannelse, mens de ikke er korreleret med den udeladte variabel, som i dette tilfælde er "ability", vil de være egnet som instrumenter. Det kan formentlig antages, at forældres uddannelse eller antal søskende ikke har indflydelse på "ability", hvorfor denne betingelse til instrumentvariablen er opfyldt. Samtidig er forældres uddannelsesniveau formentlig delvist korreleret med den pågældendes uddannelse, mens antal søskende ikke i samme grad antages at være korreleret med uddannelsesniveauet. Derfor vil forældres uddannelse formentlig være bedre instrumenter end antal søskende, men det kan ikke udelukkes at begge kan have indflydelse på uddannelsesniveauet.

## Opgave 4 - Test om uddannelse er endogen
Testen for endogenitet laves vha. den reducerede ligning, givet ved variablen mistænkt for endogenitetsproblemer regresseret på de øvrige uafhængige variable og instrumentvariablene. Heri er variablen eksogen, altså ukorreleret med det oprindelige fejlled ($u$), hvis fejlleddet fra den reducerede ligning ($v$) er ukorreleret med ($u$). Fejlleddet fra den reducerede ligning er dog ikke observeret, hvorfor residualet ($\hat{v}$) bruges som proxy. Derfor inkluderes ($\hat{v}$) i den oprindelige regression, hvorefter en t-test bruges til at teste, hvorvidt den tilhørende estimator $\delta$ er signifikant forskellig fra nul. Hvis det findes, at $\delta$ ikke kan siges at være lig 0 er den mistænkte variabel endogen. Modsat vil variablen antages at være eksogen hvis nulhypotesen $H_0: \gamma = 0$ ikke kan afvises.
```{r}
#Reduced form equation
red_model = lm(educ ~ exp + male + ethblack + ethhisp + siblings + meduc + feduc, data)
v = resid(red_model)

#Test for endogenitet, hvor residualer fra ovenstående RFE er med. Signifkans af denne vil betyde endogenitet, tror jeg?
endo_model = lm(learnings ~ educ + exp + male + ethblack + ethhisp + v, data)
summary(endo_model)
```
Inkluderes meduc, feduc og siblings som instrumentvariable for educ, er V insignifikant, hvilket indikerer educ ikke lider af endogenitet. 


## Opgave 5 - Estimer modellen vha. 2SLS hvor du gør brug af de tre beskrevne instrumenter. Sammenlign med resultaterne i spørgsmål 1.
MANGLER TEKST TIL 2SLS
```{r}
educ_fitted = fitted(red_model)

linearHypothesis(red_model, c("meduc=0", "feduc=0", "siblings=0")) #Test at IVs er signifikante

sls = lm(learnings ~ educ_fitted + exp + male + ethblack + ethhisp, data)
#summary(sls)
screenreg(list(OLS = model, two_SLS = sls), digits = 4)

#Nedenstående er 2SLS lavet i R
#sls_r = ivreg(learnings ~ educ + exp + male + ethblack + ethhisp | meduc + feduc + siblings + exp + male + ethblack + ethhisp, data = data)
#summary(sls_r)
```
MANGLER SAMMENLIGNING MED OPGAVE 1

## Opgave 6 - Udfør overidentifikationstestet. Hvad konkluderer du?
<<<<<<< HEAD

Overidentifikationstest udføres hvis man har flere instrumentale variable end endogene variable. I opgave 5 anvendes 3 instrumentale variable til den endogene variabel educ, hvorfor man bør teste for om de tre IV'er overhovedet har indflydelse på educ, og om de i så fald er statistisk ens. 
For at teste for overidentifikation anvendes residualerne fra 2SLS i opgave 5. Residualerne regreres herefter på alle exogene variable, inklusiv instrumenterne, hvorfra man kan få $R^2_1$. 
Herefter opstilles hypotesen, at alle IV'er gyldige: $H_0: corr(IV,u)=0 $ Ved at anvende $nR^2_1 \sim \chi^2_q$, hvor q er antallet af instrumentale variable fra udenfor modellen minus antallet det totale antal af endogene forklarende variable. 
Hvis nulhypotesen ikke kan afvises, er overidentifikationstesten bestået. Det vil betyde at alle instrumenterne er gyldige og modellen er præcist identificeret. Afvises $H_0$ på noget som helst signifikansniveau, da vil minimum 1 af IV'erne have endogenitetsproblemer. 

TESTEN SKAL UDFØRES
=======
MANGLER. Lektion 13. IM STILL CONFUSED
>>>>>>> d6c6d1ac6ddf6e6b02b54c15adfdfb72933f6d13

## Opgave 7 - Udfør hele analysen igen hvor du kun bruger meduc og feduc som instrumenter. Ændrer det på dine konklusioner?
```{r}
#Reduced form equation
red_model = lm(educ ~ exp + male + ethblack + ethhisp + meduc + feduc, data)
v = resid(red_model)

#Test for endogenitet, hvor residualer fra ovenstående RFE er med. Signifkans af denne vil betyde endogenitet, tror jeg?
endo_model = lm(learnings ~ educ + exp + male + ethblack + ethhisp + v, data)
summary(endo_model)
```
Der er endogenitet, fordi residualerne er signifikante (?).


```{r}
educ_fitted = fitted(red_model)

linearHypothesis(red_model, c("meduc=0", "feduc=0")) #Test at IVs er signifikante

sls2 = lm(learnings ~ educ_fitted + exp + male + ethblack + ethhisp, data)
#summary(sls)

#Sammenligning med før
screenreg(list(OLS = model, "Tre IVs" = sls, "To IVs" = sls2), digits = 4)

#Nedenstående er 2SLS lavet i R
#sls_r = ivreg(learnings ~ educ + exp + male + ethblack + ethhisp | meduc + feduc + exp + male + ethblack + ethhisp, data = data)
#summary(sls_r)
```
Ingen store ændringer

